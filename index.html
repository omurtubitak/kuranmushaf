<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuran-ı Kerim: Oku, Ara ve Sor (Genel AI)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville&family=Roboto:wght@300;400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/dexie@3.2.1/dist/dexie.js"></script>
    <style>
        :root {
            --primary-color: #00796b;
            --secondary-color: #004d40;
            --bg-color: #f8f9fa;
            --chat-width: 400px;
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Roboto', sans-serif;
            color: #333;
            overflow: hidden;
        }

        /* --- UI STYLES (Aynı kaldı) --- */
        .sidebar {
            height: calc(100vh - 70px);
            overflow-y: auto;
            border-right: 1px solid #ddd;
            background: white;
        }

        .surah-item {
            cursor: pointer;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            transition: all 0.2s;
        }

        .surah-item:hover {
            background-color: #e9ecef;
            padding-left: 20px;
        }

        .surah-item.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        .content-area {
            height: calc(100vh - 70px);
            overflow-y: auto;
            padding: 30px;
            background-color: #fff;
            scroll-behavior: smooth;
        }

        .header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            height: 70px;
            z-index: 1000;
            display: flex;
            align-items: center;
        }

        .besmele {
            text-align: center;
            font-family: 'Libre Baskerville', serif;
            font-size: 1.5rem;
            margin-bottom: 30px;
            color: var(--primary-color);
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/2/27/Basmala.svg');
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            height: 60px;
            text-indent: -9999px;
        }

        .verse-card {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px dashed #eee;
        }

        .verse-number {
            display: inline-block;
            width: 32px;
            height: 32px;
            line-height: 32px;
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            border-radius: 50%;
            font-size: 0.8rem;
            margin-right: 10px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .verse-text {
            font-size: 1.15rem;
            line-height: 1.8;
            font-family: 'Libre Baskerville', serif;
        }

        mark {
            background-color: #ffeb3b;
            padding: 0 2px;
        }

        .search-container {
            position: relative;
            max-width: 400px;
            width: 100%;
        }

        .search-container input {
            padding-right: 40px;
            border-radius: 20px;
        }

        .search-container i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
            cursor: pointer;
        }

        /* --- CHAT STYLES (Aynı kaldı) --- */
        #chat-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #00796b, #004d40);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            z-index: 2000;
            transition: transform 0.2s;
        }

        #chat-btn:hover {
            transform: scale(1.1);
        }

        .chat-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: var(--chat-width);
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .chat-header {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f4f6f8;
            font-size: 0.9rem;
        }

        .chat-footer {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .message {
            margin-bottom: 10px;
            max-width: 85%;
            padding: 10px;
            border-radius: 10px;
            word-wrap: break-word;
        }

        .message.user {
            background: #dcf8c6;
            align-self: flex-end;
            margin-left: auto;
            color: #333;
        }

        .message.ai {
            background: white;
            align-self: flex-start;
            margin-right: auto;
            border: 1px solid #ddd;
            color: #333;
        }

        .typing-indicator {
            font-style: italic;
            color: #888;
            font-size: 0.8rem;
            display: none;
        }

        .chat-body strong {
            color: var(--secondary-color);
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .content-area {
                height: calc(100vh - 70px);
            }

            .chat-window {
                width: 90%;
                right: 5%;
                bottom: 90px;
                height: 60%;
            }
        }
    </style>
</head>

<body>

    <div id="loading">
        <div class="spinner-border text-success" role="status"></div>
        <p class="mt-3">Kuran verileri yükleniyor...</p>
    </div>

    <header class="header container-fluid">
        <div class="container-fluid d-flex justify-content-between align-items-center px-4">
            <div class="d-flex align-items-center">
                <i class="fas fa-quran fa-2x me-3" style="color: var(--primary-color);"></i>
                <div>
                    <h4 class="m-0 fw-bold" style="color: var(--primary-color);">Kuran-ı Kerim</h4>
                    <small class="d-none d-md-block text-muted" style="font-size: 0.75rem;">Elmalılı Hamdi Yazır
                        Meali</small>
                </div>
            </div>
            <div class="search-container ms-3">
                <input type="text" id="searchInput" class="form-control" placeholder="Ayetlerde ara... (örn: namaz)">
                <i class="fas fa-search" onclick="performSearch()"></i>
            </div>
        </div>
    </header>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 col-lg-2 p-0 d-none d-md-block">
                <div class="sidebar" id="surahList"></div>
            </div>

            <div class="col-md-9 col-lg-10 p-0">
                <div class="content-area" id="verseContainer">
                    <div class="d-flex flex-column justify-content-center align-items-center h-100 text-muted">
                        <i class="fas fa-book-open fa-3x mb-3" style="opacity: 0.3"></i>
                        <h3>Hoşgeldiniz</h3>
                        <p>Soldan bir sure seçin veya sağ alttaki AI Asistan Mahir ile genel sorularınızı sorun.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="chat-btn" onclick="toggleChat()">
        <i class="fas fa-robot fa-lg"></i>
    </div>

    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <span><i class="fas fa-brain me-2"></i>Kuran Asistanı Mahir (Genel Bilgi)</span>
            <button type="button" class="btn-close btn-close-white" onclick="toggleChat()"></button>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="message ai">
                Selamun Aleyküm! Ben Mahir, Kuran Asistanıyım. Genel İslami bilgi, tefsir ve Kuran konularında size
                yardımcı
                olabilirim.
            </div>
        </div>
        <div class="typing-indicator ms-3 mb-2" id="typingIndicator">Asistan yazıyor...</div>
        <div class="chat-footer">
            <input type="text" id="aiInput" class="form-control" placeholder="Bir soru sorun..."
                onkeypress="handleEnter(event)">
            <button class="btn btn-success" onclick="askGemini()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        // --- KONFIGURASYON ---
        const GOOGLE_API_KEY = "AIzaSyCPNEA42dMOFIqRVcP6RFIXUZdITse_O2I";
        const API_URL = "https://cdn.jsdelivr.net/gh/fawazahmed0/quran-api@1/editions/tur-elmalilihamdiya.json";

        // Global Değişkenler
        let quranData = []; // Kuran verileri burada yüklenecek 
        let chatHistory = []; // Sohbet geçmişi burada saklanacak

        // 1. Dexie ile veritabanını oluştur ve tabloları (Object Stores) tanımla
        const db = new Dexie("MahirChatDB");
        db.version(1).stores({
            // 'history' adında bir tablo (store) oluştur.
            // 'id' anahtarı ile kayıt yapacağız. Tek bir sohbet geçmişi için 'id' anahtarını sabit tutacağız.
            history: 'id'
        });

        // 2. Konuşma Geçmişini Yükleme Fonksiyonu
        async function loadChatHistory() {
            try {
                // ID'si 1 olan sohbet geçmişini çek
                const record = await db.history.get(1);
                if (record && record.messages) {
                    chatHistory = record.messages;
                    console.log("Geçmiş başarıyla IndexedDB'den yüklendi. Mesaj Sayısı:", chatHistory.length);

                    // Yüklenen geçmişi sohbet arayüzüne (UI) aktar
                    document.getElementById('chatBody').innerHTML = ''; // Önce temizle
                    chatHistory.forEach(msg => {
                        // Sadece user ve model rolündeki mesajları göster
                        if (msg.role === 'user' || msg.role === 'model') {
                            // Sistem talimatlarını göstermeyi atla
                            if (!msg.parts[0].text.startsWith('[KONUŞMA BAŞLANGICI]')) {
                                appendMessage(msg.role, msg.parts[0].text);
                            }
                        }
                    });
                    const chatBody = document.getElementById('chatBody');
                    chatBody.scrollTop = chatBody.scrollHeight;

                } else {
                    console.log("IndexedDB'de kayıtlı geçmiş bulunamadı. Yeni sohbet başlatılıyor.");
                    chatHistory = []; // Geçmiş yoksa sıfırla
                }
            } catch (error) {
                console.error("IndexedDB yükleme hatası:", error);
                chatHistory = [];
            }
        }

        // Sayfa yüklendiğinde geçmişi yükle
        loadChatHistory();

        const surahNames = [
            "Fâtiha", "Bakara", "Âl-i İmrân", "Nisâ", "Mâide", "En'âm", "A'râf", "Enfâl", "Tevbe", "Yûnus",
            "Hûd", "Yûsuf", "Ra'd", "İbrâhîm", "Hicr", "Nahl", "İsrâ", "Kehf", "Meryem", "Tâhâ",
            "Enbiyâ", "Hac", "Mü'minûn", "Nûr", "Furkân", "Şu'arâ", "Neml", "Kasas", "Ankebût", "Rûm",
            "Lokmân", "Secde", "Ahzâb", "Sebe'", "Fâtır", "Yâsîn", "Sâffât", "Sâd", "Zümer", "Mü'min",
            "Fussilet", "Şûrâ", "Zuhruf", "Duhân", "Câsiye", "Ahkâf", "Muhammed", "Fetih", "Hucurât", "Kâf",
            "Zâriyât", "Tûr", "Necm", "Kamer", "Rahmân", "Vâkı'a", "Hadîd", "Mücâdele", "Haşr", "Mümtehine",
            "Saf", "Cum'a", "Münâfikûn", "Teğâbun", "Talâk", "Tahrîm", "Mülk", "Kalem", "Hâkka", "Me'âric",
            "Nûh", "Cin", "Müzzemmil", "Müddessir", "Kıyâme", "İnsân", "Mürselât", "Nebe'", "Nâzi'ât", "Abese",
            "Tekvîr", "İnfitâr", "Mutaffifîn", "İnşikâk", "Burûc", "Târık", "A'lâ", "Gâşiye", "Fecr", "Beled",
            "Şems", "Leyl", "Duhâ", "İnşirâh", "Tîn", "Alak", "Kadir", "Beyyine", "Zilzâl", "Âdiyât",
            "Kâri'a", "Tekâsür", "Asr", "Hümeze", "Fîl", "Kureyş", "Mâ'ûn", "Kevser", "Kâfirûn", "Nasr",
            "Tebbet", "İhlâs", "Felak", "Nâs"
        ];

        // --- BAŞLANGIÇ ---
        document.addEventListener("DOMContentLoaded", async () => {
            renderSidebar();
            document.getElementById('searchInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') performSearch();
            });

            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                quranData = data.quran;
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                alert("Kuran verileri yüklenirken hata oluştu: " + error);
            }
        });

        // --- TEMEL GÖRÜNÜM VE ARAMA FONKSİYONLARI (Aynı kaldı) ---
        function renderSidebar() {
            const listContainer = document.getElementById('surahList');
            let html = '';
            surahNames.forEach((name, index) => {
                const surahNo = index + 1;
                html += `<div class="surah-item" onclick="loadSurah(${surahNo})" id="surah-${surahNo}">
                        <span><strong>${surahNo}.</strong> ${name}</span>
                     </div>`;
            });
            listContainer.innerHTML = html;
        }

        function loadSurah(surahNo) {
            document.getElementById('searchInput').value = '';
            document.querySelectorAll('.surah-item').forEach(el => el.classList.remove('active'));
            const activeItem = document.getElementById(`surah-${surahNo}`);
            if (activeItem) {
                activeItem.classList.add('active');
                activeItem.scrollIntoView({ behavior: "smooth", block: "center" });
            }

            const verses = quranData.filter(v => v.chapter === surahNo);
            const container = document.getElementById('verseContainer');
            const surahName = surahNames[surahNo - 1];

            let contentHtml = `<div class="text-center mb-4"><h2 style="color:var(--primary-color);">${surahName} Suresi</h2><hr style="width: 50px; margin: 10px auto; border-top: 3px solid var(--primary-color);"></div>`;
            if (surahNo !== 9) contentHtml += `<div class="besmele">Bismillahirrahmanirrahim</div>`;

            verses.forEach(verse => {
                // Yeni buton formatı: Ayet kodunu ve surah adını gönderir
                const verseCode = `${verse.chapter}/${verse.verse}`;
                contentHtml += `<div class="verse-card" id="verse-${verseCode}">
                            <div class="d-flex">
                                <span class="verse-number">${verse.verse}</span>
                                <div class="verse-text w-100">${verse.text}</div>
                            </div>
                            <div class="text-end mt-2">
                                <button class="btn btn-sm btn-outline-secondary" 
                                        onclick="askMahireForVerseCode('${verseCode}', '${surahName}')">
                                    <i class="fas fa-question-circle me-1"></i> ${verseCode} Hakkında Mahire Sor
                                </button>
                            </div>
                        </div>`;
            });
            container.scrollTop = 0;
            container.innerHTML = contentHtml;
        }

        function askMahireForVerseCode(verseCode, surahName) {
            // 1. Soruyu net bir şekilde oluştur
            const question = `${surahName} suresindeki ${verseCode} ayetinin İslami açıklamasını ve tefsirini yap.`;

            // 2. Sohbet penceresini aç
            toggleChat(true);

            // 3. Input alanına soruyu yaz ve otomatik olarak AI'a sor
            const inputEl = document.getElementById('aiInput');
            inputEl.value = question;

            // Otomatik olarak göndermek için askGemini'yi çağırıyoruz
            askGemini();
        }

        // toggleChat fonksiyonunu da isteğe bağlı açma/kapama için koruyalım
        function toggleChat(forceOpen = false) {
            const win = document.getElementById('chatWindow');
            if (forceOpen) {
                win.style.display = 'flex';
            } else {
                win.style.display = (win.style.display === 'none' || win.style.display === '') ? 'flex' : 'none';
            }
        }
        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (query.length < 2) { alert("En az 2 karakter girin."); return; }

            const lowerQuery = query.toLocaleLowerCase('tr-TR');
            const results = quranData.filter(verse => verse.text.toLocaleLowerCase('tr-TR').includes(lowerQuery));

            const container = document.getElementById('verseContainer');
            if (results.length === 0) {
                container.innerHTML = `<div class="text-center mt-5">Sonuç bulunamadı.</div>`;
                return;
            }

            let html = `<div class="alert alert-info">"${query}" için ${results.length} sonuç bulundu.</div>`;
            results.forEach(verse => {
                const sName = surahNames[verse.chapter - 1];
                const regex = new RegExp(`(${query})`, 'gi');
                const highlighted = verse.text.replace(regex, '<mark>$1</mark>');

                html += `<div class="verse-card"><small class="text-muted text-uppercase">${sName} ${verse.chapter}/${verse.verse}</small><div class="d-flex mt-2">
                         <span class="verse-number" style="width:25px;height:25px;font-size:0.7rem;line-height:25px">${verse.verse}</span>
                        <div class="verse-text w-100">${highlighted}</div>
                    </div></div>`;
            });
            container.scrollTop = 0;
            container.innerHTML = html;
        }

        // --- AI CHAT FONKSİYONLARI (RAG KALDIRILDI) ---

        function toggleChat() {
            const win = document.getElementById('chatWindow');
            win.style.display = (win.style.display === 'none' || win.style.display === '') ? 'flex' : 'none';
        }

        function handleEnter(e) {
            if (e.key === 'Enter') askGemini();
        }

 // --- askGemini() fonksiyonu (GÜNCELLENMİŞ) ---
async function askGemini() {
    const inputEl = document.getElementById('aiInput');
    const userQuery = inputEl.value.trim();
    if (!userQuery) return;

    appendMessage("user", userQuery);
    inputEl.value = '';
    document.getElementById('typingIndicator').style.display = 'block';
    const chatBody = document.getElementById('chatBody');
    chatBody.scrollTop = chatBody.scrollHeight;

    // Sistem talimatı
    const systemInstruction = `
        Sen, görevi yalnızca İslami ve ahlaki çerçevede, kibar ve saygılı bir dille cevap vermek olan, uzman bir İslami asistansın.İsmin Mahir.Aşağıdaki kurallara kesinlikle uy:
        1. Kapsamlı İslami bilgini kullanarak, Kuran ve din hakkındaki soruları yanıtla. Cevapların her zaman İslami ilkelere ve Türkiye Diyanet İşleri Başkanlığı'nın genel görüşüne uygun olmalıdır.
        2. KESİNLİKLE YASAK: Ahlaki değerlere, dinin kutsallarına veya toplumsal etik kurallarına aykırı, yasa dışı, şiddet içeren, nefret söylemi içeren veya cinsel içerikli soruları reddet.
        3. RED CEVABI: Bu tür uygunsuz sorulara, "Bu tür konular hakkında konuşmam, İslami ve etik sınırlarımı aşmaktadır. Lütfen dini konularla ilgili bir soru sorun." gibi kibar ama net bir ifadeyle cevap ver.
        4. Cevaplarını Türkçe, saygılı ve akademik bir üslupla sun.
    `;
    
    // 1. KONUŞMA PENCERESİ YÖNETİMİ (Token sınırını aşmamak için)
    // MAX_TURNS'u doğru tanımladığınızı varsayarak bu kontrolü koruyoruz. 
    const MAX_TURNS = 10; // Örn: 10 soru-cevap çifti (20 mesaj) tutulacak
    // 2. SİSTEM TALİMATINI GEÇMİŞE EKLE (Sadece ilk çağrıda)
    if (chatHistory.length === 0) {
        chatHistory.push({
            role: "user", // Sistem talimatını ilk user isteği olarak gönderiyoruz.
            parts: [{ text: `[KONUŞMA BAŞLANGICI]\n${systemInstruction}` }]
        });
    }else if (chatHistory.length > (MAX_TURNS * 2) + 1) { 
    // En baştaki 2 öğeyi (En eski soru ve cevabı) sil.
    // İlk index olan 0'daki Sistem Talimatını korumak için 1. index'ten silmeye başla.
    chatHistory.splice(1, 2); 
    console.warn("Sohbet geçmişi penceresi doldu, en eski mesajlar silindi.");
}

    // 3. KULLANICININ YENİ SORUSUNU GEÇMİŞE EKLE
    chatHistory.push({
        role: "user", 
        parts: [{ text: userQuery }] 
    });

    try {
        // Netlify Fonksiyonuna TÜM chatHistory'yi gönderiyoruz
        const response = await fetch('/.netlify/functions/gemini-proxy', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                history: chatHistory // <--- DOĞRU: TÜM GEÇMİŞ GÖNDERİLİYOR
            })
        });

        const data = await response.json();

        document.getElementById('typingIndicator').style.display = 'none';

        if (data.error) {
            appendMessage("ai", `API Hatası: ${data.error.message || data.error || 'Sunucu fonksiyonu hatası.'}`);
            // Hata durumunda son eklenen kullanıcı mesajını tarihten çıkar
            chatHistory.pop();
        } else {
            const aiResponseText = data.text;
            appendMessage("ai", aiResponseText);

            // AI cevabını tarihe ekle
            chatHistory.push({
                role: "model",
                parts: [{ text: aiResponseText }]
            });

            // 4. BAŞARILI İŞLEMDEN SONRA INDEXEDDB'YE KAYDET
            saveChatHistory(); 
        }

    } catch (err) {
        document.getElementById('typingIndicator').style.display = 'none';
        appendMessage("ai", "Bağlantı hatası oluştu. Netlify fonksiyonunun çalıştığından emin olun.");
        chatHistory.pop(); 
        console.error(err);
    }
}
        async function saveChatHistory() {
            try {
                // ID'si 1 olan kaydı, güncel chatHistory dizisi ile güncelle veya oluştur (put)
                await db.history.put({ id: 1, messages: chatHistory });
                // console.log("Geçmiş IndexedDB'ye kaydedildi.");
            } catch (error) {
                console.error("Geçmiş kaydetme hatası:", error);
            }
        }

        function appendMessage(role, text) {
            const chatBody = document.getElementById('chatBody');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;

            // Markdown renderla
            msgDiv.innerHTML = marked.parse(text);

            chatBody.appendChild(msgDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }
    </script>

</body>

</html>